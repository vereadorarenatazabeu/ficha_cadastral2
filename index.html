<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Cadastro</title>
  <style>
    body { font-family:'Roboto',Arial,sans-serif; background:#fff; margin:0; padding:0; }
    .top-image { width:100%; max-height:650px; overflow:hidden; }
    .top-image img { width:100%; height:auto; display:block; }
    form {
      background:rgba(255,255,255,0.98);
      padding:25px;
      border-radius:8px;
      margin:20px auto;
      max-width: 600px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
      margin-bottom: 15px;
    }
    input, select {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
    }
    input[type=submit] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #1a73e8;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 15px;
    }
    input[type=submit]:hover { background:#1669c1; }
    input[type=submit]:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .msg { text-align:center; color:green; font-weight:bold; margin-top:10px; }
    .msg.error { color: #d32f2f; }
    #outrosInteressesDiv { display:none; margin-top:5px; }
    .cep-status { font-size: 12px; margin-top: 2px; }
    .loading { color: #1a73e8; }
    .error { color: #d32f2f; }
    .success { color: #388e3c; }
  </style>

  <script>
    // COLOCA A URL DO WEB APP DO APPS SCRIPT AQUI
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyvXlfXsyfyMjTiHzbg_BGKYQZDL8BXwcIyk7l-H-paai4tLQ0Mw0zxsxzZFKho-LZNZQ/exec';

    function mascarar(input,tipo){
      let v = input.value.replace(/\D/g,'');
      if(tipo==='cep'){
        if(v.length>5)v=v.slice(0,5)+'-'+v.slice(5,8);
        input.value=v;
      }
      else if(tipo==='telefone'){
        if(v.length>11)v=v.slice(0,11);
        if(v.length>6) input.value='('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7);
        else if(v.length>2) input.value='('+v.slice(0,2)+') '+v.slice(2);
        else input.value=v;
      }
      else if(tipo==='dataNascimento'){
        if(v.length>8) v=v.slice(0,8);
        if(v.length>4) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8);
        else if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2,4);
        input.value=v;
      }
    }

    async function buscarCep(){
      const cepInput = document.getElementById('cep');
      const enderecoInput = document.getElementById('endereco');
      const bairroInput = document.getElementById('bairro');

      if(!cepInput || !enderecoInput || !bairroInput) return;

      const cep = cepInput.value.replace(/\D/g,'');
      if(cep.length !== 8) return;

      enderecoInput.value = '';
      bairroInput.value = '';

      let statusElement = document.getElementById('cep-status');
      if(!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'cep-status';
        statusElement.className = 'cep-status';
        cepInput.parentNode.appendChild(statusElement);
      }
      statusElement.className = 'cep-status loading';
      statusElement.textContent = 'Buscando endereço...';

      enderecoInput.disabled = true;
      bairroInput.disabled = true;

      const apis = [
        {
          url: `https://viacep.com.br/ws/${cep}/json/`,
          parser: (data) => ({
            endereco: data.logradouro || '',
            bairro: data.bairro || ''
          })
        },
        {
          url: `https://brasilapi.com.br/api/cep/v1/${cep}`,
          parser: (data) => ({
            endereco: data.street || '',
            bairro: data.neighborhood || ''
          })
        },
        {
          url: `https://cdn.apicep.com/file/apicep/${cep}.json`,
          parser: (data) => ({
            endereco: data.address || '',
            bairro: data.district || ''
          })
        }
      ];

      for(let api of apis) {
        try {
          const response = await fetch(api.url);
          
          if(response.ok) {
            const data = await response.json();
            
            if(!data.erro && !data.error) {
              const resultado = api.parser(data);
              
              if(resultado.endereco || resultado.bairro) {
                enderecoInput.value = resultado.endereco;
                bairroInput.value = resultado.bairro;
                statusElement.className = 'cep-status success';
                statusElement.textContent = '✓ Endereço encontrado';
                
                enderecoInput.disabled = false;
                bairroInput.disabled = false;
                
                setTimeout(() => {
                  if(statusElement && statusElement.parentNode) {
                    statusElement.remove();
                  }
                }, 3000);
                
                return;
              }
            }
          }
        } catch(err) {
          console.log('Erro na API:', err);
          continue;
        }
      }

      enderecoInput.disabled = false;
      bairroInput.disabled = false;
      statusElement.className = 'cep-status error';
      statusElement.textContent = 'CEP não encontrado';
    }

    function mostrarOutrosInteresses(){
      const select = document.getElementById('interesses');
      const div = document.getElementById('outrosInteressesDiv');
      div.style.display = select.value==='Outros' ? 'block' : 'none';
    }

    function validarFormulario(dados){
      if(!dados.nome||!dados.dataNascimento||!dados.telefone||!dados.cep||
        !dados.endereco||!dados.bairro||!dados.numero||!dados.interesses){
        alert('Preencha todos os campos obrigatórios!');
        return false;
      }
      if(dados.cep.replace(/\D/g,'').length!==8){
        alert('CEP inválido!');
        return false;
      }
      if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dados.dataNascimento)){
        alert('Data de nascimento inválida. Use o formato DD/MM/AAAA.');
        return false;
      }
      return true;
    }

    function coletarDados() {
      const interesses = document.getElementById('interesses').value==='Outros'
        ? document.getElementById('outrosInteresses').value.trim()
        : document.getElementById('interesses').value;
      return {
        nome:document.getElementById('nome').value.trim(),
        dataNascimento:document.getElementById('dataNascimento').value.trim(),
        telefone:document.getElementById('telefone').value.trim(),
        cep:document.getElementById('cep').value.trim(),
        endereco:document.getElementById('endereco').value.trim(),
        bairro:document.getElementById('bairro').value.trim(),
        numero:document.getElementById('numero').value.trim(),
        interesses:interesses
      };
    }

    // ENVIO DE DADOS - funciona no GitHub Pages sem preflight
    async function enviarDados(event){
      event.preventDefault();
  
      const dados = coletarDados();
      if(!validarFormulario(dados)) return;
  
      const submitButton = document.querySelector('input[type="submit"]');
      const msgDiv = document.getElementById('msg');
  
      submitButton.disabled = true;
      submitButton.value = 'Enviando...';
      msgDiv.textContent = '';
      msgDiv.className = 'msg';

      try {
    // NOTE: NÃO enviar headers personalizados nem Content-Type application/json
    // para evitar preflight OPTIONS. O Apps Script receberá e.postData.contents.
        const response = await fetch(WEBAPP_URL, {
          method: 'POST',
          body: JSON.stringify(dados),
          redirect: 'follow'
        });

    // ainda pode lançar se a rede falhar
        const result = await response.json();
    
        if(result.success) {
          msgDiv.textContent = result.message;
          msgDiv.className = 'msg';
          document.querySelector('form').reset();
          mostrarOutrosInteresses();
        } else {
          msgDiv.textContent = result.message || '❌ Erro ao enviar o formulário.';
          msgDiv.className = 'msg error';
        }
    
      } catch(err) {
        console.error('Erro:', err);
        msgDiv.textContent = '❌ Erro ao enviar o formulário. Tente novamente.';
        msgDiv.className = 'msg error';
      } finally {
        submitButton.disabled = false;
        submitButton.value = 'Enviar';
      }
    }

  </script>
</head>

<body>
  <div class="top-image"><img src="https://i.imgur.com/BeorX7x.png" alt="Imagem Topo"></div>

  <form onsubmit="enviarDados(event)">
    <label>Nome: <input type="text" id="nome" required></label>
    <label>Data de nascimento: <input type="text" id="dataNascimento" required oninput="mascarar(this,'dataNascimento')" placeholder="dd/mm/aaaa"></label>
    <label>Telefone: <input type="text" id="telefone" required oninput="mascarar(this,'telefone')" placeholder="(99) 99999-9999"></label>
    <label>CEP:
      <input type="text" id="cep" required oninput="mascarar(this,'cep')" onblur="buscarCep()" placeholder="Somente números"></label>
    <label>Endereço: <input type="text" id="endereco" required></label>
    <label>Bairro: <input type="text" id="bairro" required></label>
    <label>Número: <input type="text" id="numero" required></label>

    <label>Interesses:
      <select id="interesses" onchange="mostrarOutrosInteresses()">
        <option value="" disabled selected hidden></option>
        <option>Pet</option>
        <option>Saúde</option>
        <option>Educação</option>
        <option>Segurança</option>
        <option>Outros</option>
      </select>
    </label>
    <div id="outrosInteressesDiv">
      <input type="text" id="outrosInteresses" placeholder="Descreva seu interesse">
    </div>

    <input type="submit" value="Enviar">
    <div id="msg" class="msg"></div>
  </form>
</body>
</html>
